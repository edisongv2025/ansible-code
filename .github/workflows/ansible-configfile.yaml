on:
  workflow_dispatch:

jobs:
  generate-ansible-cfg:
    runs-on: [ ansible-master ]

    steps:


      - name: Generate ansible.cfg
        run: |
          sudo -u edison bash -c 'cat > /home/edison/ansible/ansible.cfg' << 'EOF'
          [defaults]
          inventory      = /home/edison/ansible/inventory.yaml
          roles_path    = /home/edison/ansible/roles
          host_key_checking = False
          remote_user = edison
          private_key_file = /home/edison/.ssh/id_rsa
          log_path = /home/edison/ansible/ansible.log
          forks = 5
          gathering = smart
          fact_caching = jsonfile
          fact_caching_connection = /home/edison/ansible/facts_cache
          

          [privilege_escalation]
          become = True
          become_method = sudo
          become_user = root
          become_ask_pass = False

          [ssh_connection]
          ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o ConnectTimeout=10
          control_path = /home/edison/.ssh/id_rsa-%%r@%%h:%%p
          EOF
          

      - name: Set proper permissions
        run: |
          sudo chown edison:edison /home/edison/ansible/ansible.cfg
          sudo chmod 644 /home/edison/ansible/ansible.cfg

      - name: Verify configuration
        run: |
          echo "Ansible configuration:"
          sudo -u edison ls -la /home/edison/ansible/ansible.cfg
          echo -e "\nContents:"
          sudo -u edison cat /home/edison/ansible/ansible.cfg
